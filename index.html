<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANR - Analisis Laporan Produk NG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Sidebar & Layout Utility */
        .sidebar-link { transition: all 0.3s ease; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #4f46e5; color: white; }
        #sidebar.collapsed { margin-left: -16rem; }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- PDF/PRINT SPECIFIC STYLES (A4 LANDSCAPE) --- */
        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: white; }
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            #sidebar, header, .no-print { display: none !important; }
        }

        /* Struktur Tabel Presisi (Mirip Excel/PDF) */
        .pdf-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-family: Arial, Helvetica, sans-serif; 
            font-size: 10px; /* Ukuran font dikecilkan agar muat */
            color: black; 
            border: 2px solid black;
        }
        .pdf-table td, .pdf-table th { 
            border: 1px solid black; 
            padding: 4px; 
            vertical-align: top; 
            line-height: 1.2;
        }
        .pdf-header { 
            background-color: #fbbf24; /* Warna Kuning */
            font-weight: bold; 
            text-transform: uppercase; 
            text-align: left;
            padding: 4px;
            border-bottom: 1px solid black;
        }
        .field-label { font-weight: bold; display: inline-block; width: 85px; }
        .chk-box { display: inline-block; width: 10px; height: 10px; border: 1px solid black; margin-right: 2px; text-align: center; line-height: 9px; font-size: 8px; }
        .chk-box.checked { background-color: black; color: white; }
        
        /* Helper untuk input action split */
        .split-col { width: 50%; vertical-align: top; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="flex h-screen">
        <aside id="sidebar" class="w-64 bg-gray-800 text-gray-200 flex-shrink-0 flex-col transition-all duration-300 ease-in-out flex no-print">
            <div class="h-20 flex items-center justify-center bg-gray-900"><h1 class="text-2xl font-bold">ANR System</h1></div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#dashboard" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg"><i class="fas fa-tachometer-alt fa-fw"></i> Dashboard</a>
                <a href="#list-anr" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg"><i class="fas fa-list-alt fa-fw"></i> List ANR</a>
                <a href="#analisis" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg"><i class="fas fa-chart-pie fa-fw"></i> Analisis & Grafik</a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <div class="text-sm">Logged in as:</div>
                <div id="user-info" class="font-semibold truncate">Offline Admin</div>
                <button id="logout-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Reset Data</button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex-shrink-0 bg-white shadow-md z-10 no-print">
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center gap-4">
                        <button id="sidebar-toggle-btn" class="text-gray-600 hover:text-gray-900 p-2 rounded-full hover:bg-gray-100"><i class="fas fa-bars text-xl"></i></button>
                        <h1 id="page-title" class="text-2xl font-bold text-gray-800"></h1>
                    </div>
                </div>
            </header>
            <main id="page-content" class="flex-1 overflow-y-auto p-6 lg:p-10"></main>
        </div>
    </div>
    
    <div id="loading-screen" class="h-screen w-screen flex items-center justify-center bg-gray-900 text-white absolute inset-0 z-50">
        <div class="text-center"><i class="fas fa-spinner fa-spin text-4xl mb-4"></i><p>Memuat Mode Offline...</p></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    // --- 1. MOCK BACKEND ---
    const DB_KEY_ANR = 'anr_local_db_reports';
    const DB_KEY_MEMBERS = 'anr_local_db_members';

    const mockDB = {
        getCollection: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
        saveCollection: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        onSnapshot: (collectionName, callback) => {
            const fetchData = () => {
                const rawData = collectionName.includes('members') ? mockDB.getCollection(DB_KEY_MEMBERS) : mockDB.getCollection(DB_KEY_ANR);
                const docs = rawData.map(item => ({ id: item.id, data: () => item }));
                callback({ docs });
            };
            fetchData(); window.addEventListener('storage', fetchData); 
        },
        addDoc: async (collectionName, data) => {
            const key = collectionName.includes('members') ? DB_KEY_MEMBERS : DB_KEY_ANR;
            const currentData = mockDB.getCollection(key);
            const newDoc = { id: 'doc_' + Date.now(), ...data };
            currentData.push(newDoc);
            mockDB.saveCollection(key, currentData);
            window.dispatchEvent(new Event('storage')); return { id: newDoc.id };
        },
        updateDoc: async (docId, data) => {
            const key = DB_KEY_ANR; let currentData = mockDB.getCollection(key);
            const idx = currentData.findIndex(d => d.id === docId);
            if (idx !== -1) { currentData[idx] = { ...currentData[idx], ...data }; mockDB.saveCollection(key, currentData); window.dispatchEvent(new Event('storage')); }
        },
        deleteDoc: async (docId, collectionName) => {
            let key = collectionName.includes('members') ? DB_KEY_MEMBERS : DB_KEY_ANR;
            let currentData = mockDB.getCollection(key);
            let idx = currentData.findIndex(d => d.id === docId);
            if (idx !== -1) { currentData.splice(idx, 1); mockDB.saveCollection(key, currentData); window.dispatchEvent(new Event('storage')); }
        },
        getDocs: async (collectionName) => {
            const rawData = collectionName.includes('members') ? mockDB.getCollection(DB_KEY_MEMBERS) : mockDB.getCollection(DB_KEY_ANR);
             return { docs: rawData.map(item => ({ data: () => item })) };
        }
    };

    const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error);
    });

    // --- 2. CONFIG ---
    let currentAnrData = [];
    let dashConfig = { month: new Date().getMonth(), year: new Date().getFullYear(), budget: 220000000 };
    const divisionOptions = ["Cyl Grinding", "Surface Grinding", "CNC", "Program", "Lathe", "Radial", "QC", "Resharping", "Produksi", "Assy", "Sales", "PPIC", "Eksternal"];
    const flowProcessOptions = ["Material", "Material Inspection", "Gun Drill", "Deep Hole", "Rough Lathe", "Rough Frais", "Finish Frais", "Stress Relief", "NC Program", "Finish Lathe", "Radial Drill", "Rough Grinding", "Rough Surface Grinding", "NC Machining", "Check Before Harden", "Harden", "Check After Harden", "Grinding Before Inside", "Inside Grinding", "Semi Surface Grinding", "Check Before Wirecut/EDM", "Wirecut/EDM", "Check After Wirecut", "Semi Grinding", "Finish Surface Grinding", "Check Before Assy", "Hiyashibame", "Grinding After Assy", "QC", "NC Key / NC2", "Tanmen & Center Sushei", "Final Grinding", "Resharpening", "Assy", "Final Inspection"];
    
    // --- 3. CORE ---
    window.addEventListener('DOMContentLoaded', () => { setTimeout(() => { document.getElementById('loading-screen').classList.add('hidden'); initApp(); }, 500); });

    function initApp() {
        document.getElementById('app-container').classList.remove('hidden');
        document.getElementById('sidebar-toggle-btn').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
        document.getElementById('logout-btn').addEventListener('click', () => { if(confirm('Reset Data?')) { localStorage.clear(); location.reload(); } });
        window.addEventListener('hashchange', handleRouting);
        mockDB.onSnapshot('anr_reports', (snapshot) => {
            currentAnrData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const hash = window.location.hash || '#dashboard';
            if (hash === '#dashboard') renderDashboardPage();
            else if (hash.startsWith('#list-anr') && !hash.includes('/')) renderListAnrPage();
        });
        handleRouting();
    }

    function handleRouting() {
        const hash = window.location.hash || '#dashboard';
        document.querySelectorAll('.sidebar-link').forEach(link => link.classList.toggle('active', link.getAttribute('href') === hash.split('/')[0]));
        const [route, action, id] = hash.substring(1).split('/');
        if (route === 'list-anr') {
            if (action === 'form') renderAnrForm(); 
            else if (action === 'edit') renderAnrForm(id); 
            else if (action === 'view') renderDetailView(id); 
            else renderListAnrPage();
        } else if (route === 'analisis') {
            document.getElementById('page-content').innerHTML = '<div class="p-10 text-center text-gray-500">Fitur Analisis Grafik belum tersedia.</div>';
            document.getElementById('page-title').textContent = 'Analisis';
        } else { renderDashboardPage(); }
    }

    function formatCurrency(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); }

    // --- 4. DASHBOARD ---
    function renderDashboardPage() {
        document.getElementById('page-title').textContent = 'Dashboard Utama';
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const monthlyData = currentAnrData.filter(anr => { const d = new Date(anr.tanggalKejadian); return d.getMonth() === parseInt(dashConfig.month) && d.getFullYear() === parseInt(dashConfig.year); });
        const monthlyCases = monthlyData.length;
        const monthlyClaims = monthlyData.filter(anr => anr.masalah === 'Claim Customer').length;
        const monthlyLoss = monthlyData.reduce((acc, curr) => acc + Number(curr.totalKerugian || 0), 0);
        const totalLossYTD = yearlyData.reduce((acc, curr) => acc + Number(curr.totalKerugian || 0), 0);
        const remainingBudget = dashConfig.budget - totalLossYTD;
        const delayedCases = currentAnrData.filter(a => a.status === 'Delayed');

        document.getElementById('page-content').innerHTML = `
            <div class="flex justify-between items-end mb-6"><div><p class="text-sm text-gray-500 font-semibold">Periode</p><h2 class="text-2xl font-bold text-gray-800 mt-2">${monthNames[dashConfig.month]} ${dashConfig.year}</h2></div><button id="open-filter-btn" class="bg-white border hover:bg-gray-50 px-4 py-2 rounded-lg shadow-sm text-sm font-semibold">Ganti Periode</button></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500"><h2 class="text-gray-500 text-sm font-semibold">Kejadian NG</h2><p class="text-3xl font-bold text-gray-800 mt-2">${monthlyCases} <span class="text-lg font-normal text-gray-500">Kasus</span></p></div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500"><h2 class="text-gray-500 text-sm font-semibold">Claim Customer</h2><p class="text-3xl font-bold text-red-600 mt-2">${monthlyClaims} <span class="text-lg font-normal text-gray-500">Kasus</span></p></div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500"><h2 class="text-gray-500 text-sm font-semibold">Total Loss NG</h2><p class="text-3xl font-bold text-indigo-700 mt-2">${formatCurrency(monthlyLoss)}</p></div>
            </div>
            <h3 class="text-lg font-bold text-gray-700 mb-3">Monitoring Budget ${dashConfig.year}</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow flex justify-between items-center relative group"><div><h2 class="text-gray-500 text-sm font-semibold flex items-center gap-2">Maksimal Budget <button id="edit-budget-btn" class="text-gray-400 hover:text-indigo-600"><i class="fas fa-pencil-alt text-xs"></i></button></h2><p class="text-2xl font-bold text-gray-800 mt-1">${formatCurrency(dashConfig.budget)}</p></div><i class="fas fa-wallet text-gray-300 text-4xl opacity-50"></i></div>
                <div class="bg-white p-6 rounded-xl shadow flex justify-between items-center"><div><h2 class="text-gray-500 text-sm font-semibold">Sisa Budget (YTD)</h2><p class="text-2xl font-bold ${remainingBudget < 0 ? 'text-red-600' : 'text-green-600'} mt-1">${formatCurrency(remainingBudget)}</p><p class="text-xs text-gray-400 mt-1">Terpakai: ${formatCurrency(totalLossYTD)}</p></div><div class="h-10 w-10 rounded-full flex items-center justify-center ${remainingBudget < 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}"><i class="fas fa-chart-pie text-lg"></i></div></div>
            </div>
            <div id="modal-period" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm"><div class="bg-white rounded-xl p-6"><h3 class="font-bold mb-4">Pilih Periode</h3><select id="input-month" class="border p-2 w-full mb-2">${monthNames.map((m, i) => `<option value="${i}" ${i == dashConfig.month ? 'selected' : ''}>${m}</option>`).join('')}</select><input type="number" id="input-year" value="${dashConfig.year}" class="border p-2 w-full mb-4"><button id="btn-save-period" class="bg-indigo-600 text-white px-4 py-2 rounded">Terapkan</button></div></div>
            <div id="modal-budget" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm"><div class="bg-white rounded-xl shadow-2xl p-6 w-96"><h3 class="font-bold mb-4">Atur Budget</h3><div><label class="block text-sm mb-1">Nominal (Rp)</label><input type="number" id="input-budget" value="${dashConfig.budget}" class="w-full border rounded p-2 text-lg font-bold"></div><div class="flex justify-end gap-2 mt-6"><button id="btn-close-budget" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded text-sm">Batal</button><button id="btn-save-budget" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm shadow">Simpan</button></div></div></div>
        `;
        document.getElementById('open-filter-btn').addEventListener('click', () => document.getElementById('modal-period').classList.remove('hidden'));
        document.getElementById('btn-save-period').addEventListener('click', () => { dashConfig.month = parseInt(document.getElementById('input-month').value); dashConfig.year = parseInt(document.getElementById('input-year').value); document.getElementById('modal-period').classList.add('hidden'); renderDashboardPage(); });
        const modalBudget = document.getElementById('modal-budget');
        const editBtn = document.getElementById('edit-budget-btn');
        if(editBtn) editBtn.addEventListener('click', () => modalBudget.classList.remove('hidden'));
        document.getElementById('btn-close-budget').addEventListener('click', () => modalBudget.classList.add('hidden'));
        document.getElementById('btn-save-budget').addEventListener('click', () => { const val = parseFloat(document.getElementById('input-budget').value); if(val > 0) { dashConfig.budget = val; modalBudget.classList.add('hidden'); renderDashboardPage(); } });
    }

   // --- 5. PAGE: LIST & CRUD ---
    async function renderListAnrPage() {
        document.getElementById('page-title').textContent = 'Daftar Laporan ANR';
        document.getElementById('page-content').innerHTML = `
            <div class="flex justify-between mb-6"><input type="text" placeholder="Cari..." class="border p-2 rounded-lg w-64 shadow-sm"><a href="#list-anr/form" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700"><i class="fas fa-plus"></i> Buat Laporan</a></div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${currentAnrData.map(anr => `
                <div class="bg-white rounded-lg shadow hover:shadow-lg p-4 flex flex-col relative">
                    <img src="${anr.gambarProduk || 'https://placehold.co/400x300?text=No+Image'}" class="w-full h-40 object-cover rounded mb-3 bg-gray-100">
                    <span class="absolute top-6 right-6 text-xs px-2 py-1 rounded-full ${anr.status === 'Delayed' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'} shadow-sm">${anr.status || 'Open'}</span>
                    <h3 class="font-bold text-lg truncate text-gray-800">${anr.namaProduk}</h3>
                    <p class="text-sm text-gray-500 mb-2">${anr.noAnr}</p>
                    <div class="mt-auto flex gap-2 pt-3 border-t">
                        <a href="#list-anr/view/${anr.id}" class="flex-1 text-center bg-blue-50 hover:bg-blue-100 text-blue-700 py-2 rounded text-sm font-bold border border-blue-200"><i class="fas fa-file-pdf"></i> PDF</a>
                        <a href="#list-anr/edit/${anr.id}" class="flex-1 text-center bg-green-50 hover:bg-green-100 text-green-700 py-2 rounded text-sm font-bold border border-green-200"><i class="fas fa-edit"></i> Edit</a>
                        <button class="delete-btn text-red-500 px-2 hover:bg-red-50 rounded" data-id="${anr.id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('')}
            </div>`;
        document.querySelectorAll('.delete-btn').forEach(btn => { btn.addEventListener('click', async (e) => { if(confirm('Hapus?')) await mockDB.deleteDoc(e.currentTarget.dataset.id, 'anr_reports'); }); });
    }

   // --- 6. PAGE: FORM (INPUT & EDIT) ---
    async function renderAnrForm(editId = null) {
        const isEdit = !!editId;
        document.getElementById('page-title').textContent = isEdit ? 'Edit ANR' : 'Input ANR Baru';
        
        let membersList = [];
        let editData = {};
        try { 
            const snap = await mockDB.getDocs('members'); membersList = snap.docs.map(d => d.data().nama).sort();
            if(isEdit) editData = mockDB.getCollection('anr_local_db_reports').find(x => x.id === editId) || {};
        } catch (e) { membersList = ["Admin"]; }
        
        const memberOptionsHtml = membersList.map(name => `<option value="${name}">${name}</option>`).join('');
        
        const generateWhyInputs = (namePrefix) => { let html = ''; for(let i=1; i<=3; i++) html += `<div class="flex gap-2 mb-2"><span class="w-6 text-right font-bold text-gray-400">${i}.</span><input type="text" name="${namePrefix}[]" class="flex-1 border rounded p-2 text-sm" placeholder="Analisis..."></div>`; return html; };
        const renderSignCell = (role, label) => `<td class="border-2 border-black p-1 h-32 align-top bg-white hover:bg-gray-50"><div class="flex flex-col justify-between h-full relative"><input type="file" id="file-sign-${role}" class="hidden sign-file-input" data-role="${role}" accept="image/*"><div id="drop-zone-${role}" class="flex-1 flex flex-col items-center justify-center cursor-pointer border border-dashed border-gray-300 rounded hover:border-indigo-500"><div id="placeholder-sign-${role}" class="text-center text-gray-400 text-xs"><i class="fas fa-cloud-upload-alt"></i><br>TTD</div><img id="preview-sign-${role}" class="absolute inset-0 w-full h-full object-contain hidden bg-white"></div><input type="text" list="member-suggestions" name="sign${role}Name" class="w-full text-center border-b border-black text-xs font-bold mt-1" placeholder="(${label})"></div></td>`;

        document.getElementById('page-content').innerHTML = `
            <datalist id="member-suggestions">${memberOptionsHtml}</datalist>
            <form id="anr-form" class="bg-white p-6 rounded-xl shadow-lg space-y-6 max-w-6xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 border-b pb-4">
                    <div><label class="text-xs font-bold text-gray-500">No. ANR</label><input type="text" name="noAnr" class="w-full border rounded p-2 text-sm" required></div>
                    <div><label class="text-xs font-bold text-gray-500">No. Worksheet</label><input type="text" name="noWorksheet" class="w-full border rounded p-2 text-sm"></div>
                    <div><label class="text-xs font-bold text-gray-500">No. Drawing</label><input type="text" name="noDrawing" class="w-full border rounded p-2 text-sm"></div>
                    <div><label class="text-xs font-bold text-gray-500">Tanggal</label><input type="date" name="tanggalKejadian" class="w-full border rounded p-2 text-sm" required></div>
                    <div><label class="text-xs font-bold text-gray-500">Customer</label><input type="text" name="namaCustomer" class="w-full border rounded p-2 text-sm"></div>
                    <div><label class="text-xs font-bold text-gray-500">Produk</label><input type="text" name="namaProduk" class="w-full border rounded p-2 text-sm" required></div>
                    <div><label class="text-xs font-bold text-gray-500">Judul Masalah</label><input type="text" name="judulMasalah" class="w-full border rounded p-2 text-sm"></div>
                    <div><label class="text-xs font-bold text-gray-500">Kerugian (Rp)</label><input type="number" name="totalKerugian" class="w-full border rounded p-2 text-sm text-red-600 font-bold" placeholder="0"></div>
                    <div><label class="text-xs font-bold text-gray-500">Tempat Ditemukan</label><select name="tempatDitemukan" class="w-full border rounded p-2 text-sm"><option value="">-</option>${divisionOptions.map(d=>`<option>${d}</option>`).join('')}</select></div>
                    <div><label class="text-xs font-bold text-gray-500">Tempat Kejadian</label><select name="tempatKejadian" class="w-full border rounded p-2 text-sm"><option value="">-</option>${divisionOptions.map(d=>`<option>${d}</option>`).join('')}</select></div>
                    <div class="bg-gray-50 p-2 rounded border"><div class="text-xs font-bold mb-1">Sumber</div><div class="flex gap-2 text-xs"><label><input type="radio" name="masalah" value="Internal"> Internal</label><label><input type="radio" name="masalah" value="Subcont"> Subcont</label><label><input type="radio" name="masalah" value="Claim Customer"> Claim</label></div></div>
                    <div class="bg-gray-50 p-2 rounded border"><div class="text-xs font-bold mb-1">Status</div><div class="flex gap-2 text-xs"><label><input type="radio" name="jenisKasus" value="Baru"> Baru</label><label><input type="radio" name="jenisKasus" value="Berulang"> Ulang</label></div></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-4">
                        <div><label class="text-xs font-bold">Kronologi</label><textarea name="kronologi" rows="4" class="w-full border rounded p-2 text-sm"></textarea></div>
                        <div><label class="text-xs font-bold">Flow Process</label><div class="grid grid-cols-3 gap-2 bg-gray-50 p-2 border h-32 overflow-y-auto text-xs">${flowProcessOptions.map(p=>`<label><input type="checkbox" name="flowProcess" value="${p}"> ${p}</label>`).join('')}</div></div>
                    </div>
                    <div class="bg-gray-50 p-4 border flex flex-col items-center justify-center">
                        <input type="file" id="img-upload" accept="image/*" class="text-xs mb-2">
                        <img id="img-preview" class="h-32 object-contain hidden bg-white border">
                    </div>
                </div>
                <div class="grid grid-cols-5 gap-2 bg-gray-50 p-2 rounded border">
                    ${['Man','Machine','Method','Material','Env'].map(c => `<div><label class="text-[10px] font-bold uppercase">${c}</label><input type="text" name="analisis${c}" class="w-full border rounded p-1 text-xs"></div>`).join('')}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-orange-50 p-4 rounded border border-orange-200">
                        <div class="flex justify-between mb-2"><label class="font-bold text-orange-800 text-sm">Why Make</label><button type="button" id="add-why-make" class="text-xs bg-white border px-2 py-1 rounded">Tambah</button></div>
                        <div id="container-why-make">${generateWhyInputs('whyMake')}</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded border border-orange-200">
                        <div class="flex justify-between mb-2"><label class="font-bold text-orange-800 text-sm">Why Send</label><button type="button" id="add-why-send" class="text-xs bg-white border px-2 py-1 rounded">Tambah</button></div>
                        <div id="container-why-send">${generateWhyInputs('whySend')}</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold">Temporary Action</label><textarea name="tempAction" class="w-full border rounded p-2 text-sm"></textarea></div>
                    <div><label class="text-xs font-bold">Permanent Action</label><textarea name="permAction" class="w-full border rounded p-2 text-sm"></textarea></div>
                </div>
                <div class="grid grid-cols-2 gap-4 bg-yellow-50 p-4 border border-yellow-200 rounded">
                    <div><label class="text-xs font-bold">Tanggal Selesai</label><input type="date" name="tanggalSelesai" class="w-full border rounded p-1"></div>
                    <div><label class="text-xs font-bold">Berat Material</label><input type="text" name="beratMaterial" class="w-full border rounded p-1"></div>
                    <div><label class="text-xs font-bold">Jenis Material</label><input type="text" name="jenisMaterial" class="w-full border rounded p-1"></div>
                    <div><label class="text-xs font-bold">Lokasi Simpan</label><input type="text" name="lokasiPenyimpanan" class="w-full border rounded p-1"></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border-2 border-black text-center text-xs">
                        <tr class="bg-gray-100 font-bold"><th class="border-2 border-black p-2">Issued</th><th colspan="3" class="border-2 border-black p-2">Checked</th><th colspan="2" class="border-2 border-black p-2">Known</th></tr>
                        <tr class="bg-gray-100 font-bold"><th class="border-2 border-black">Pembuat</th><th class="border-2 border-black">Leader</th><th class="border-2 border-black">SPV</th><th class="border-2 border-black">Manager</th><th class="border-2 border-black">QC</th><th class="border-2 border-black">Quality</th></tr>
                        <tr>${renderSignCell('Issued','Pembuat')}${renderSignCell('Leader','Leader')}${renderSignCell('Spv','SPV')}${renderSignCell('Manager','Manager')}${renderSignCell('Qc','QC')}${renderSignCell('Quality','Quality')}</tr>
                    </table>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" onclick="history.back()" class="px-4 py-2 border rounded">Batal</button>
                    <button type="submit" id="submit-btn" class="px-6 py-2 bg-indigo-600 text-white rounded font-bold shadow">${isEdit?'Update':'Simpan'}</button>
                </div>
            </form>
        `;

        const addDynamicRow = (containerId, namePrefix, val='') => {
            const container = document.getElementById(containerId);
            const count = container.children.length + 1;
            const div = document.createElement('div'); div.className = 'flex gap-2 mb-2';
            div.innerHTML = `<span class="w-6 text-right font-bold text-gray-400">${count}.</span><input type="text" name="${namePrefix}[]" value="${val}" class="flex-1 border rounded p-2 text-sm"><button type="button" class="text-red-500 p-1" onclick="this.parentElement.remove()">x</button>`;
            container.appendChild(div);
        };

        if(isEdit && editData.noAnr) {
            const f = document.getElementById('anr-form');
            Array.from(f.elements).forEach(el => { if(editData[el.name]) el.value = editData[el.name]; });
            ['masalah','jenisKasus'].forEach(k => { if(editData[k]) { const r = f.querySelector(`input[name="${k}"][value="${editData[k]}"]`); if(r) r.checked=true; } });
            if(editData.flowProcess) editData.flowProcess.forEach(v => { const c = f.querySelector(`input[value="${v}"]`); if(c) c.checked=true; });
            if(editData.whyMake) { document.getElementById('container-why-make').innerHTML=''; editData.whyMake.forEach(v => addDynamicRow('container-why-make','whyMake',v)); }
            if(editData.whySend) { document.getElementById('container-why-send').innerHTML=''; editData.whySend.forEach(v => addDynamicRow('container-why-send','whySend',v)); }
            if(editData.gambarProduk) { document.getElementById('img-preview').src = editData.gambarProduk; document.getElementById('img-preview').classList.remove('hidden'); document.getElementById('img-upload').dataset.b64 = editData.gambarProduk; }
            ['Issued','Leader','Spv','Manager','Qc','Quality'].forEach(r => {
                if(editData[`sign${r}Img`]) { document.getElementById(`preview-sign-${r}`).src = editData[`sign${r}Img`]; document.getElementById(`preview-sign-${r}`).classList.remove('hidden'); document.getElementById(`file-sign-${r}`).dataset.b64 = editData[`sign${r}Img`]; }
            });
        }

        document.getElementById('add-why-make').onclick = () => addDynamicRow('container-why-make', 'whyMake');
        document.getElementById('add-why-send').onclick = () => addDynamicRow('container-why-send', 'whySend');

        const setupImg = (id, previewId) => { const inp = document.getElementById(id); inp.onchange = async (e) => { if(e.target.files[0]) { const b = await fileToBase64(e.target.files[0]); document.getElementById(previewId).src=b; document.getElementById(previewId).classList.remove('hidden'); inp.dataset.b64=b; }}; };
        setupImg('img-upload', 'img-preview');
        document.querySelectorAll('.sign-file-input').forEach(el => setupImg(el.id, `preview-sign-${el.dataset.role}`));

        document.getElementById('anr-form').onsubmit = async (e) => {
            e.preventDefault(); const fd = new FormData(e.target); const data = Object.fromEntries(fd.entries());
            data.whyMake = Array.from(document.querySelectorAll('input[name="whyMake[]"]')).map(i=>i.value).filter(v=>v);
            data.whySend = Array.from(document.querySelectorAll('input[name="whySend[]"]')).map(i=>i.value).filter(v=>v);
            data.flowProcess = Array.from(document.querySelectorAll('input[name="flowProcess"]:checked')).map(i=>i.value);
            data.gambarProduk = document.getElementById('img-upload').dataset.b64 || null;
            ['Issued','Leader','Spv','Manager','Qc','Quality'].forEach(r => data[`sign${r}Img`] = document.getElementById(`file-sign-${r}`).dataset.b64 || null);

            if(isEdit) await mockDB.updateDoc(editId, data); else await mockDB.addDoc('anr_reports', { ...data, status: 'Open' });
            alert('Tersimpan!'); window.location.hash = '#list-anr';
        };
    }

    // --- 7. PAGE: DETAIL VIEW (FIXED PRECISE LAYOUT) ---
    function renderDetailView(id) {
        const anr = currentAnrData.find(x => x.id === id);
        if (!anr) return document.getElementById('page-content').innerHTML = '<p>Data tidak ditemukan.</p>';
        document.getElementById('page-title').textContent = 'Review Laporan (PDF View)';

        const renderCheck = (val, currentVal) => `<span class="chk-box ${val === currentVal ? 'checked' : ''}">${val === currentVal ? '&#10003;' : ''}</span>`;
        const renderFlow = (flows) => (flows||[]).join(' <span class="text-gray-400">&rarr;</span> ');

        document.getElementById('page-content').innerHTML = `
            <div class="flex justify-between mb-4 no-print">
                <button onclick="history.back()" class="bg-gray-500 text-white px-4 py-2 rounded">Kembali</button>
                <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded"><i class="fas fa-print"></i> Cetak PDF</button>
            </div>

            <div id="printable-area" class="bg-white mx-auto shadow-lg text-black" style="width: 297mm; height: 210mm; padding: 5mm;">
                
                <div class="font-bold text-lg mb-1 uppercase">PT. TSUJIKAWA INDONESIA</div>

                <table class="pdf-table">
                    <tr>
                        <th class="pdf-header" width="20%">1. KONDISI KEJADIAN</th>
                        <th class="pdf-header" width="20%">2. DETAIL MASALAH</th>
                        <th class="pdf-header" width="60%">FLOW PROCESS & KERUGIAN</th>
                    </tr>
                    
                    <tr>
                        <td>
                            <div class="mb-1"><span class="field-label">No. ANR</span>: ${anr.noAnr || '-'}</div>
                            <div class="mb-1"><span class="field-label">Worksheet</span>: ${anr.noWorksheet || '-'}</div>
                            <div class="mb-1"><span class="field-label">Customer</span>: ${anr.namaCustomer || '-'}</div>
                            <div class="mb-1"><span class="field-label">Produk</span>: <strong>${anr.namaProduk || '-'}</strong></div>
                            <div class="mb-1"><span class="field-label">Judul</span>: ${anr.judulMasalah || '-'}</div>
                        </td>
                        
                        <td>
                            <div class="mb-1"><span class="field-label">No. Drawing</span>: ${anr.noDrawing || '-'}</div>
                            <div class="mb-1"><span class="field-label">Tanggal</span>: ${anr.tanggalKejadian || '-'}</div>
                            <div class="mb-1"><span class="field-label">Tempat Kejadian</span>: ${anr.tempatKejadian || '-'}</div>
                            <div class="mb-1"><span class="field-label">Ditemukan</span>: ${anr.tempatDitemukan || '-'}</div>
                            <div class="mb-1"><span class="field-label">Total Rugi</span>: <strong>${formatCurrency(anr.totalKerugian || 0)}</strong></div>
                        </td>

                        <td style="padding:0; vertical-align:top;">
                            <div style="height: 90px; border-bottom: 1px solid black; padding: 4px; overflow: hidden;">
                                <strong>Flow Process:</strong><br>
                                <span style="font-size:9px;">${renderFlow(anr.flowProcess)}</span>
                            </div>
                            <div style="padding: 4px; font-size: 9px;">
                                <div>Raw Material: -</div>
                                <div>Proses Ext: -</div>
                                <div>Proses Int: -</div>
                            </div>
                        </td>
                    </tr>
                </table>

                <table class="pdf-table" style="border-top: none;">
                    <tr>
                        <td width="20%" style="padding:0; border-right:1px solid black;">
                            <div style="padding:4px; border-bottom:1px solid black;">
                                <strong>Masalah:</strong><br>
                                ${renderCheck('Internal', anr.masalah)} Internal 
                                ${renderCheck('Subcont', anr.masalah)} Subcont 
                                ${renderCheck('Claim Customer', anr.masalah)} Claim
                            </div>
                            <div style="height:120px; text-align:center; border-bottom:1px solid black; display:flex; align-items:center; justify-content:center;">
                                <img src="${anr.gambarProduk || ''}" style="max-width:95%; max-height:95%;">
                            </div>
                            <div style="padding:4px;">
                                <strong>Kesimpulan:</strong><br>
                                ${renderCheck('Repair', anr.kesimpulan)} Repair<br>
                                ${renderCheck('NG', anr.kesimpulan)} NG<br>
                                ${renderCheck('Re-turn Cust', anr.kesimpulan)} Return
                            </div>
                        </td>

                        <td width="60%" style="padding:0; vertical-align:top;">
                            <div class="pdf-header" style="border:none; border-bottom:1px solid black; text-align:center;">3. KRONOLOGI & ANALISIS (4M + 1E)</div>
                            <div style="padding:5px; height:80px; overflow:hidden; border-bottom:1px solid black; text-align:justify;">
                                <strong>Kronologi:</strong> ${anr.kronologi || '-'}
                            </div>
                            <div style="display:flex;">
                                <div style="width:50%; border-right:1px solid black; height:120px;">
                                    <div style="background:#eee; text-align:center; font-weight:bold; border-bottom:1px solid black;">Why Make</div>
                                    <ol style="padding-left:20px; margin:2px;">${(anr.whyMake||[]).map(x=>`<li>${x}</li>`).join('')}</ol>
                                </div>
                                <div style="width:50%; height:120px;">
                                    <div style="background:#eee; text-align:center; font-weight:bold; border-bottom:1px solid black;">Why Send</div>
                                    <ol style="padding-left:20px; margin:2px;">${(anr.whySend||[]).map(x=>`<li>${x}</li>`).join('')}</ol>
                                </div>
                            </div>
                        </td>

                        <td width="20%" style="padding:0; vertical-align:top;">
                            <div class="pdf-header" style="border:none; border-bottom:1px solid black; text-align:center;">4. 4M + 1E</div>
                            <div style="border-bottom:1px solid black; padding:2px; height:32px;"><strong>Man:</strong> ${anr.analisisMan||''}</div>
                            <div style="border-bottom:1px solid black; padding:2px; height:32px;"><strong>Machine:</strong> ${anr.analisisMachine||''}</div>
                            <div style="border-bottom:1px solid black; padding:2px; height:32px;"><strong>Method:</strong> ${anr.analisisMethod||''}</div>
                            <div style="border-bottom:1px solid black; padding:2px; height:32px;"><strong>Material:</strong> ${anr.analisisMaterial||''}</div>
                            <div style="padding:2px; height:32px;"><strong>Env:</strong> ${anr.analisisEnv||''}</div>
                        </td>
                    </tr>
                </table>

                <table class="pdf-table" style="border-top: none;">
                    <tr>
                        <th class="pdf-header" width="50%">5. DETAIL PERBAIKAN</th>
                        <th class="pdf-header" width="25%">6. MONITORING</th>
                        <th class="pdf-header" width="25%">7. IDENTITAS PRODUK</th>
                    </tr>
                    <tr>
                        <td style="padding:0;">
                            <div style="display:flex; height:100px;">
                                <div style="width:50%; border-right:1px solid black; padding:4px;">
                                    <strong>Temporary Action:</strong><br>${anr.tempAction||'-'}
                                </div>
                                <div style="width:50%; padding:4px;">
                                    <strong>Permanent Action:</strong><br>${anr.permAction||'-'}
                                </div>
                            </div>
                        </td>
                        <td>
                            <strong>Due Date:</strong> ${anr.tanggalSelesai||'-'}<br><br>
                            <strong>Note:</strong> ${anr.noteTambahan||'-'}
                        </td>
                        <td>
                            <strong>Berat:</strong> ${anr.beratMaterial||'-'}<br>
                            <strong>Jenis:</strong> ${anr.jenisMaterial||'-'}<br>
                            <strong>Lokasi:</strong> ${anr.lokasiPenyimpanan||'-'}
                        </td>
                    </tr>
                </table>

                <div style="margin-top:5px; text-align:right; font-size:10px;">Cikarang, ${new Date().toLocaleDateString('id-ID')}</div>
                <table class="pdf-table" style="text-align:center;">
                    <tr style="background-color:#f3f4f6; font-weight:bold;">
                        <td width="16%">Issued By</td>
                        <td colspan="3">Checked By</td>
                        <td colspan="2">Known By</td>
                    </tr>
                    <tr style="background-color:#f3f4f6; font-size:9px; font-weight:bold;">
                        <td>Pembuat</td>
                        <td width="16%">Leader</td>
                        <td width="16%">Supervisor</td>
                        <td width="16%">Manager</td>
                        <td width="16%">QC</td>
                        <td width="16%">Team Quality</td>
                    </tr>
                    <tr style="height: 60px;">
                        ${['Issued','Leader','Spv','Manager','Qc','Quality'].map(r => `
                            <td style="vertical-align: bottom;">
                                ${anr[`sign${r}Img`] ? `<img src="${anr[`sign${r}Img`]}" style="height:30px; display:block; margin:0 auto;">` : ''}
                                <div style="border-top:1px solid black; margin-top:4px;">${anr[`sign${r}Name`] || '...'}</div>
                            </td>
                        `).join('')}
                    </tr>
                </table>
            </div>
        `;
    }
    </script>
</body>
</html>
